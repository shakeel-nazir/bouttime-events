name: Build events.json

on:
  workflow_dispatch:
  push:
    paths:
      - ".github/workflows/build.yml"
  schedule:
    - cron: "17 */6 * * *" # every 6 hours

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Build events.json
        run: |
          python - <<'PY'
          import json, re
          from datetime import datetime, timedelta, timezone
          from urllib.request import urlopen, Request

          def http_get(url, headers=None):
            headers = headers or {}
            req = Request(url, headers={"User-Agent":"Mozilla/5.0", **headers})
            with urlopen(req, timeout=30) as r:
              return r.read().decode("utf-8", "replace")

          def ymd(d): return d.strftime("%Y-%m-%d")

          def parse_ics(ics_text):
            # unfold lines
            raw = ics_text.replace("\r\n","\n").split("\n")
            lines = []
            for ln in raw:
              if ln.startswith((" ", "\t")) and lines:
                lines[-1] += ln.strip()
              else:
                lines.append(ln.strip())

            events = []
            cur = None
            for ln in lines:
              if ln == "BEGIN:VEVENT":
                cur = {}
                continue
              if ln == "END:VEVENT":
                if cur and cur.get("DTSTART") and cur.get("SUMMARY"):
                  events.append(cur)
                cur = None
                continue
              if cur is None: 
                continue

              if ":" not in ln:
                continue
              key, val = ln.split(":", 1)
              key = key.split(";", 1)[0].upper().strip()
              cur[key] = val.strip()

            return events

          def ics_dt_to_iso(dt):
            # YYYYMMDD or YYYYMMDDTHHMMSSZ or YYYYMMDDTHHMMSS
            dt = dt.strip()
            m = re.match(r"^(\d{4})(\d{2})(\d{2})$", dt)
            if m:
              # noon UTC to avoid day shift
              d = datetime(int(m[1]), int(m[2]), int(m[3]), 12, 0, 0, tzinfo=timezone.utc)
              return d.isoformat().replace("+00:00","Z"), False

            m = re.match(r"^(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2})Z$", dt)
            if m:
              d = datetime(int(m[1]), int(m[2]), int(m[3]), int(m[4]), int(m[5]), int(m[6]), tzinfo=timezone.utc)
              return d.isoformat().replace("+00:00","Z"), True

            m = re.match(r"^(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2})$", dt)
            if m:
              d = datetime(int(m[1]), int(m[2]), int(m[3]), int(m[4]), int(m[5]), int(m[6]), tzinfo=timezone.utc)
              return d.isoformat().replace("+00:00","Z"), True

            return None, False

          def dedupe(items):
            seen=set(); out=[]
            for e in items:
              k=(e["sport"], e["name"], e["dayKey"])
              if k in seen: 
                continue
              seen.add(k)
              out.append(e)
            return out

          now = datetime.now(timezone.utc)
          horizon = now + timedelta(days=180)

          out_events = []

          # UFC (server-side, no CORS issues)
          try:
            ufc_ics = http_get("https://www.ufc.com/events/ical")
            for ev in parse_ics(ufc_ics):
              iso, has_time = ics_dt_to_iso(ev["DTSTART"])
              if not iso: 
                continue
              d = datetime.fromisoformat(iso.replace("Z","+00:00"))
              if d < now - timedelta(days=7) or d > horizon:
                continue
              out_events.append({
                "sport": "UFC",
                "name": ev.get("SUMMARY","").strip(),
                "date": iso,
                "hasRealTime": bool(has_time),
                "venue": ev.get("LOCATION","").strip(),
                "city": "",
                "dayKey": ymd(d.astimezone(timezone.utc)),
                "source": ""  # blank so you don’t see “TheSportsDB”
              })
          except Exception as e:
            # keep going even if UFC fails
            pass

          # Boxing (SportsDB free endpoint by day)
          key = "3"
          d = (now - timedelta(days=2)).date()
          end = horizon.date()
          while d <= end:
            ds = d.isoformat()
            try:
              url = f"https://www.thesportsdb.com/api/v1/json/{key}/eventsday.php?d={ds}&s=Boxing"
              j = json.loads(http_get(url))
              for ev in (j.get("events") or []):
                name = (ev.get("strEvent") or "").strip()
                if not name:
                  continue
                out_events.append({
                  "sport": "BOX",
                  "name": name,
                  "date": f"{ds}T12:00:00Z",
                  "hasRealTime": False,
                  "venue": (ev.get("strVenue") or "").strip(),
                  "city": (ev.get("strLocation") or "").strip(),
                  "dayKey": ds,
                  "source": ""  # blank so you don’t see “TheSportsDB”
                })
            except Exception:
              pass
            d += timedelta(days=1)

          out_events = dedupe(out_events)
          out_events.sort(key=lambda e: e["date"])

          payload = {
            "generatedAt": datetime.now(timezone.utc).isoformat().replace("+00:00","Z"),
            "events": out_events
          }

          with open("events.json","w",encoding="utf-8") as f:
            json.dump(payload, f, ensure_ascii=False, indent=2)

          print(f"Wrote events.json with {len(out_events)} events")
          PY

      - name: Commit events.json (if changed)
        run: |
          git config user.name "bouttime-bot"
          git config user.email "actions@users.noreply.github.com"
          git add events.json
          git diff --staged --quiet && echo "No changes" && exit 0
          git commit -m "Update events.json"
          git push
